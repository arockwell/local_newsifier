# Alembic Database Migrations

This directory contains [Alembic](https://alembic.sqlalchemy.org/en/latest/) migration scripts for the Local Newsifier database.

## Overview

Alembic is a database migration tool for SQLAlchemy, used to track and apply changes to the database schema over time. It allows for:

- Version control of database schema changes
- Safe, repeatable migrations across development and production environments
- Automatic generation of migration scripts based on model changes
- Capability to upgrade and downgrade the database schema

## Directory Structure

- `alembic/versions/`: Contains individual migration script files
- `alembic/env.py`: Configuration for the Alembic environment
- `alembic.ini`: Main Alembic configuration file

## Using the Migration Script

We've provided a convenient script to run common migration tasks: `scripts/db_migration.py`.

### Available Commands

```bash
# Verify database connection
python scripts/db_migration.py verify

# Show current migration version
python scripts/db_migration.py current

# Show migration history
python scripts/db_migration.py history

# Upgrade database to latest version
python scripts/db_migration.py upgrade

# Upgrade database to specific version
python scripts/db_migration.py upgrade --revision <revision_id>

# Downgrade database to previous version
python scripts/db_migration.py downgrade --revision <revision_id>

# Create a new migration from model changes
python scripts/db_migration.py create --message "Description of changes"
```

## Manual Alembic Usage

If you prefer to use Alembic directly:

```bash
# Show current version
alembic current

# Upgrade to latest version
alembic upgrade head

# Create new migration
alembic revision --autogenerate -m "Description of changes"

# Upgrade to specific version
alembic upgrade <revision_id>

# Downgrade to specific version
alembic downgrade <revision_id>

# Show migration history
alembic history
```

## Migration Workflow

### Creating New Migrations

When you make changes to the SQLModel models:

1. Make your changes to the model definitions
2. Run: `python scripts/db_migration.py create --message "Description of changes"`
3. Review the generated migration script in `alembic/versions/`
4. Apply the migration: `python scripts/db_migration.py upgrade`

### Applying Migrations

When pulling code that contains new migrations:

1. Run: `python scripts/db_migration.py upgrade`

## Troubleshooting

- If you encounter issues with autogeneration, make sure all models are properly imported in `local_newsifier/models/__init__.py`
- For connection issues, verify database settings in your environment or `.env` file
- If migrations fail, check the error message and migration script for issues
- Try running with a specific revision ID to isolate problematic migrations

## Best Practices

- Always review autogenerated migration scripts before applying them
- Create migrations for specific, focused changes rather than large batches
- Include clear, descriptive messages with each migration
- Test migrations in development before applying to production
- Never modify existing migration scripts after they've been committed
