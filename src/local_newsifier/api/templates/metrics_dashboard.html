{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Performance Metrics Dashboard</h2>
    <p class="text-muted">Last updated: {{ metrics.timestamp }}</p>

    <!-- API Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>API Metrics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Total Requests</h5>
                        <p class="metric-value">{{ metrics.api.total_requests|int }}</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Active Requests</h5>
                        <p class="metric-value">{{ metrics.api.active_requests|int }}</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Avg Response Time</h5>
                        <p class="metric-value">{{ "%.3f"|format(metrics.api.average_duration) }}s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Error Rate</h5>
                        <p class="metric-value">
                            {% if metrics.api.total_requests > 0 %}
                                {{ "%.1f"|format((metrics.api.errors_by_endpoint.values()|sum / metrics.api.total_requests * 100)) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <h5 class="mt-3">Requests by Endpoint</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Count</th>
                            <th>Errors</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for endpoint, count in metrics.api.requests_by_endpoint.items() %}
                        <tr>
                            <td>{{ endpoint }}</td>
                            <td>{{ count|int }}</td>
                            <td>{{ metrics.api.errors_by_endpoint.get(endpoint, 0)|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Database Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Database Metrics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Total Queries</h5>
                        <p class="metric-value">{{ metrics.database.total_queries|int }}</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Slow Queries (&gt;1s)</h5>
                        <p class="metric-value text-{{ 'danger' if metrics.database.slow_queries > 0 else 'success' }}">
                            {{ metrics.database.slow_queries|int }}
                        </p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Avg Query Time</h5>
                        <p class="metric-value">{{ "%.3f"|format(metrics.database.average_query_time) }}s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Connection Pool</h5>
                        <p class="metric-value">{{ metrics.database.connection_pool_size|int }}</p>
                    </div>
                </div>
            </div>

            <h5 class="mt-3">Queries by Operation</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for operation, count in metrics.database.queries_by_operation.items() %}
                        <tr>
                            <td>{{ operation|upper }}</td>
                            <td>{{ count|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Celery Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Celery Task Metrics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Total Tasks</h5>
                        <p class="metric-value">{{ metrics.celery.total_tasks|int }}</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Success Rate</h5>
                        <p class="metric-value text-{{ 'success' if metrics.celery.total_tasks == 0 or (metrics.celery.successful_tasks / metrics.celery.total_tasks) > 0.95 else 'warning' }}">
                            {% if metrics.celery.total_tasks > 0 %}
                                {{ "%.1f"|format((metrics.celery.successful_tasks / metrics.celery.total_tasks * 100)) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Failed Tasks</h5>
                        <p class="metric-value text-{{ 'danger' if metrics.celery.failed_tasks > 0 else 'success' }}">
                            {{ metrics.celery.failed_tasks|int }}
                        </p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box">
                        <h5>Avg Duration</h5>
                        <p class="metric-value">{{ "%.2f"|format(metrics.celery.average_task_duration) }}s</p>
                    </div>
                </div>
            </div>

            {% if metrics.celery.tasks_by_name %}
            <h5 class="mt-3">Tasks by Name</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Total</th>
                            <th>Success</th>
                            <th>Failed</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task_name, stats in metrics.celery.tasks_by_name.items() %}
                        <tr>
                            <td>{{ task_name.split('.')[-1] }}</td>
                            <td>{{ stats.total|int }}</td>
                            <td class="text-success">{{ stats.success|int }}</td>
                            <td class="text-danger">{{ stats.failure|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- System Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>System Metrics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="metric-box">
                        <h5>Memory Usage</h5>
                        <p class="metric-value">{{ "%.1f"|format(metrics.system.memory_usage_mb) }} MB</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-box">
                        <h5>CPU Usage</h5>
                        <p class="metric-value">{{ "%.1f"|format(metrics.system.cpu_usage_percent) }}%</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-box">
                        <h5>App Version</h5>
                        <p class="metric-value">{{ metrics.system.app_info.get('version', 'N/A') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Entity Processing Metrics -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Entity Processing Metrics</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="metric-box">
                        <h5>Total Entities Extracted</h5>
                        <p class="metric-value">{{ metrics.entities.total_entities_extracted|int }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-box">
                        <h5>Avg Extraction Time</h5>
                        <p class="metric-value">{{ "%.3f"|format(metrics.entities.average_extraction_time) }}s</p>
                    </div>
                </div>
            </div>

            {% if metrics.entities.entities_by_type %}
            <h5 class="mt-3">Entities by Type</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Entity Type</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entity_type, count in metrics.entities.entities_by_type.items() %}
                        <tr>
                            <td>{{ entity_type }}</td>
                            <td>{{ count|int }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="/metrics" class="btn btn-secondary">View Raw Metrics</a>
        <a href="/system/metrics/api" class="btn btn-primary">Get JSON</a>
        <a href="/system/metrics/baseline" class="btn btn-info">View Baseline</a>
    </div>
</div>

<style>
.metric-box {
    text-align: center;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
}

.metric-box h5 {
    font-size: 14px;
    color: #6c757d;
    margin-bottom: 10px;
}

.metric-value {
    font-size: 24px;
    font-weight: bold;
    margin: 0;
}

.card-header {
    background-color: #007bff;
    color: white;
}

.card-header h4 {
    margin: 0;
}
</style>
{% endblock %}
